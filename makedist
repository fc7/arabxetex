#!/bin/bash

if [ "$1" = "-h" ]; then 
echo "usage: makedist [option]"
echo "Option -m forces generating the mappings"
exit 0
fi

mapcount=`ls mappings/*.tec 2> /dev/null | wc -w`

if [ "$1" = "-m" -o ! -d mappings -o $mapcount = 0 ]; then
perl makemaps.pl
fi

distdir="dist"
mapsdir="dist/fontmapping/"
docdir="dist/doc/"
srcdir="dist/source/"
#texdir="dist/xelatex/"
locmapsdir="loc/fonts/misc/xetex/fontmapping/arabxetex/"
locdocdir="loc/doc/xelatex/arabxetex/"
locsrcdir="loc/source/xelatex/arabxetex/"
loctexdir="loc/tex/xelatex/"

mkdir -p $locmapsdir
mkdir -p $locdocdir/examples
mkdir -p $locsrcdir
mkdir -p $loctexdir
mkdir -p $mapsdir
mkdir -p $srcdir
mkdir -p dist/examples
#mkdir -p $texdir

cp mappings/*.{map,tec} $mapsdir
mv mappings/*.{map,tec} $locmapsdir
rm -rf mappings/

echo "Recompile arabxetex.dtx? [y/N]"
read -en 1 RECOMPILE_Q
if [ "$RECOMPILE_Q" = "y" ] || [ "$RECOMPILE_Q" = "Y" ]; then
	xelatex arabxetex.dtx
	xelatex arabxetex.dtx
	xelatex arabxetex.dtx
fi

cp *-trans*.map $srcdir 
cp *.maps $srcdir
cp makemaps.pl $srcdir
cp arabxetex.pdf dist/
cp arabxetex.dtx dist/
cp ednotes_example.{tex,pdf} dist/examples
cp minimal.{tex,pdf} dist/examples
#cp arabxetex.sty $texdir
cp README dist/

cp *-trans*.map $locsrcdir 
cp *.maps $locsrcdir
cp makemaps.pl $locsrcdir
cp arabxetex.pdf $locdocdir
cp arabxetex.dtx $locsrcdir
cp ednotes_example.{tex,pdf} $locdocdir/examples
cp minimal.tex $locdocdir/examples
cp arabxetex.sty $loctexdir || exit 1
cp README $locdocdir

[ -f arabxetex.zip ] && mv arabxetex.zip arabxetex.zip.bak
cd loc
zip -r arabxetex.tds.zip *
mv arabxetex.tds.zip ../
cd ..
rm -fr loc/
cd dist
zip -r arabxetex.zip *
mv arabxetex.zip ../
cd ..
zip arabxetex.zip arabxetex.tds.zip
rm -fr dist/

echo "arabxetex.zip can be uploaded on CTAN..."

echo "Install to ~/texmf/ ? [y/N]"
read -en 1 INSTALL_Q
if [ "$INSTALL_Q" = "y" ] || [ "$INSTALL_Q" = "Y" ]; then
  TEXMFHOME="$HOME/Library/texmf"
  unzip -uo arabxetex.tds.zip -d $TEXMFHOME/ 
  mktexlsr $TEXMFHOME
  echo "update completed"
fi
rm arabxetex.tds.zip
rm arabxetex*.{aux,glo,idx,ins,log,out,sty,toc}
rm README.tex
